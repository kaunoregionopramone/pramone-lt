name: Weekly Sanity Backup

on:
  schedule:
    # Every Sunday at 02:00 UTC
    - cron: "0 2 * * 0"
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Sanity dependencies
        working-directory: studio
        run: npm install

      - name: Set date variables
        run: |
          echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Export Sanity dataset
        working-directory: studio
        env:
          SANITY_AUTH_TOKEN: ${{ secrets.SANITY_AUTH_TOKEN }}
          SANITY_STUDIO_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
          SANITY_STUDIO_DATASET: production
        run: |
          npx sanity dataset export production ../sanity-backup-${DATE}.tar.gz

      - name: Install rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configure rclone for Cloudflare R2
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
          acl = private
          EOF

      - name: Upload backup to Cloudflare R2
        run: |
          rclone copy sanity-backup-${DATE}.tar.gz r2:${{ secrets.R2_BUCKET_NAME }}/ --progress

      - name: Delete backups older than 60 days
        run: |
          rclone delete r2:${{ secrets.R2_BUCKET_NAME }}/ \
            --min-age 60d \
            --include "sanity-backup-*.tar.gz"

      - name: Cleanup local files
        run: rm -f sanity-backup-*.tar.gz
